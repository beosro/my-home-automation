homeassistant:
  customize:
    script.all_rooms_audio:
      friendly_name: Spotify Everywhere
      icon: mdi:spotify
      emulated_hue: true
    script.ui_tts:
      friendly_name: Play TTS
      icon: mdi:play
    media_player.spotify:
      emulated_hue: true
      emulated_hue_name: speakers

group:
  Snapclients:
    - media_player.snapcast_client_74da3868e5f1
    - media_player.snapcast_client_b827ebc8b2f8
    - media_player.snapcast_client_b827ebacb8f7
    - media_player.snapcast_group_0cf71a2ae7f4714e27fa32012d5f373a
    - script.all_rooms_audio
  TTS:
    - media_player.mpd
    - input_text.tts
    - script.ui_tts

tts:
  - platform: google
    cache: true
    cache_dir: /tmp/tts
    time_memory: 300
  - platform: amazon_polly
    aws_access_key_id: !secret aws_access_key_id
    aws_secret_access_key: !secret aws_secret_access_key
    region_name: !secret aws_region
  - platform: voicerss
    api_key: !secret voicerss_api_key

input_text:
  tts:
    name: Text to speak

ffmpeg:
  ffmpeg_bin: /usr/bin/ffmpeg

media_player:
  - platform: snapcast
    host: localhost
  - platform: mpd
    host: localhost
  - platform: spotify
    client_id: !secret spotify_client_id
    client_secret: !secret spotify_client_secret

script:
  all_rooms_audio:
    sequence:
      - service: media_player.select_source
        data:
          entity_id: media_player.spotify
          source: 'Multi-Room Audio'
      - service: media_player.select_source
        data:
          entity_id: media_player.snapcast_group_0cf71a2ae7f4714e27fa32012d5f373a
          source: 'Spotify'
      - service: switch.turn_on
        data:
          entity_id: switch.hdmi_5
      - service: hdmi_cec.select_device
        data:
          device: '1.2.0.0'
      - service: input_select.select_option
        data:
          entity_id: input_select.tv_input
          option: 'Multi-Room Audio'
  ui_tts:
    sequence:
      - service: script.turn_on
        entity_id: script.play_tts
        data_template:
          variables:
            message: '{{states.input_text.tts.state}}'
  play_tts:
    sequence:
      - service: snapcast.snapcast_snapshot
        data:
          entity_id:
            - media_player.snapcast_group_0cf71a2ae7f4714e27fa32012d5f373a
            - media_player.snapcast_client_b827ebc8b2f8
            - media_player.snapcast_client_b827ebacb8f7
      - service: media_player.select_source
        data:
          entity_id: media_player.snapcast_group_0cf71a2ae7f4714e27fa32012d5f373a
          source: TTS
      - service: media_player.volume_set
        data:
          entity_id: media_player.snapcast_client_b827ebc8b2f8
          volume_level: 0.5
      - service: media_player.volume_set
        data:
          entity_id: media_player.snapcast_client_b827ebacb8f7
          volume_level: 1.0
      - service_template: "tts.{{states.input_select.tts_engine.state}}_say"
        data_template:
          entity_id: media_player.mpd
          message: "{{message}}"
      - wait_template: "{{states.media_player.mpd.state == 'off'}}"
        timeout: 120
      - service: snapcast.snapcast_restore
        data:
          entity_id:
            - media_player.snapcast_group_0cf71a2ae7f4714e27fa32012d5f373a
            - media_player.snapcast_client_b827ebc8b2f8
            - media_player.snapcast_client_b827ebacb8f7

automation:
  - alias: Multi-Room Audio Pause
    trigger:
      platform: mqtt
      topic: lirc/status/insig/KEY_PAUSE
      payload: '0'
    action:
      service_template: media_player.media_pause
      entity_id: media_player.multiroom_audio
  - alias: Multi-Room Audio Play
    trigger:
      platform: mqtt
      topic: lirc/status/insig/KEY_PLAY
      payload: '0'
    action:
      service_template: media_player.media_play
      entity_id: media_player.multiroom_audio
